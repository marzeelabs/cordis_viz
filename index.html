<!DOCTYPE html>
<meta charset="utf-8">
<title>Crossfilter</title>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
  
<!-- Markercluster -->
<link rel="stylesheet" href="lib/Leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="lib/Leaflet.markercluster/dist/MarkerCluster.Default.css" />
<!--[if lte IE 8]><link rel="stylesheet" href="lib/Leaflet.markercluster/dist/MarkerCluster.Default.ie.css" /><![endif]-->

<!-- Bootstrap -->
<link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">

<style>

@import url(http://fonts.googleapis.com/css?family=Lobster);

body {
  font-family: "Helvetica Neue";
  margin: 40px auto;
  width: 960px;
  min-height: 2000px;
}

#body {
  position: relative;
}

#map { height: 350px; }

footer {
  padding: 2em 0 1em 0;
  font-size: 12px;
}

.attribution {
  font-size: 12px;
}

h1 {
  font-size: 96px;
  margin-top: .3em;
  margin-bottom: 0;
}

h1 + h2 {
  margin-top: 0;
}

h2 {
  font-weight: 400;
  font-size: 28px;
}

h1, h2 {
  font-family: "Lobster";
  text-rendering: optimizeLegibility;
}

#body > p {
  line-height: 1.5em;
  width: 640px;
  text-rendering: optimizeLegibility;
}

#charts {
  padding: 10px 0;
}

.chart {
  display: inline-block;
  height: 151px;
  margin-bottom: 20px;
}

.reset {
  padding-left: 1em;
  font-size: smaller;
  color: #ccc;
}

.background.bar {
  fill: #ccc;
}

.foreground.bar {
  fill: steelblue;
}

.axis path, .axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis text {
  font: 10px sans-serif;
}

.brush rect.extent {
  fill: steelblue;
  fill-opacity: .125;
}

.brush .resize path {
  fill: #eee;
  stroke: #666;
}

#hour-chart {
  width: 260px;
}

#delay-chart {
  width: 230px;
}

#distance-chart {
  width: 420px;
}

#date-chart {
  width: 920px;
}

#project-list {
  min-height: 1024px;
}

#project-list .date,
#project-list .day {
  margin-bottom: .4em;
}

#project-list .flight {
  line-height: 1.5em;
  background: #eee;
  width: 640px;
  margin-bottom: 1px;
}

#project-list .time {
  color: #999;
}

#project-list .flight div {
  display: inline-block;
  width: 100px;
}

#project-list div.acronym {
  width: 160px;
  padding-right: 10px;
  text-align: right;
}

#project-list div.project-call {
  width: 200px;
  padding-left: 10px;
  text-align: left;
}

#project-list div.funding,
#project-list div.duration {
  width: 100px;
  padding-right: 10px;
  text-align: right;
}

#project-list .early {
  color: green;
}

aside {
  position: absolute;
  left: 740px;
  font-size: smaller;
  width: 220px;
}

</style>

<div id="body">

<h1>Cordis</h1>
<h2>Visualization of Science Funding in Europe</h2>


<aside id="totals"><span id="active">-</span> of <span id="total">-</span> projects selected.</aside>

<div id="lists">
  <div id="project-list" class="list"></div>
  <div id="country-list" class="list"></div>
  <div id="project-calls-list" class="list"></div>
</div>


<div id="charts">

  <div id="date-chart" class="chart">
    <div class="title">Project Start Date</div>
  </div>

  <div id="end-date-chart" class="chart">
    <div class="title">Project End Date</div>
  </div>
</div>



<div id="map"></div>



<!-- <div class="modal fade in" aria-hidden="false" aria-labelledby="datapointevent" role="dialog" tabindex="-1" id="myModal" style="display: block;">
  <div class="modal-header">
    <button class="close" aria-hidden="true" data-dismiss="modal" type="button">x</button>
    <h4 id="datapointevent"></h4>
  </div>
  <div class="modal-body">
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span4">
          <h4>Event Date</h4>
          <span id="datapointdate">December 24, 2013</span>
        </div>
        <div class="span4">
          <h4>Location</h4>
          <span id="datapointlocation">Iran/Mashhad</span>
        </div>
        <div class="span4">
          <h4>Stage</h4>
          <span id="datapointstage">Polarization</span>
        </div>
      </div>
      <div class="row-fluid">
        <div class="span12">
          <h4 class="control-label" for="description">Description</h4>
          <span id="datapointdescription">On the morning of December 24, agents from the Ministry of Intelligence in Iran arrested Mozhde Zohuri, ( مژده ظهوری ) in her home in Mashhad. They also searched her home and seized religious books, a mobile phone and some personal effects. Mozhde Zohuri is the wife of Farhad Fahandezh (فرهاد فهندژ), who was arrested in his home on October 16, 2012, and later transferred first to Evin prison and then to Raja’i Shahr, before being sentenced to 10 years in prison. He is serving his sentence in Raja’i Shahr.</span>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" aria-hidden="true" data-dismiss="modal">Close</button>
  </div>
</div> -->

<span style="float:right;" class="attribution">
  Original data from <a href="http://cordis.europa.eu/">Cordis</a>.
</span>
<footer>
  Copyright 2014 <a href="http://openconsortium.eu">Open Consortium</a>
</footer>

</div>

<script src="crossfilter.v1.min.js"></script>
<script src="d3.v3.min.js"></script>
<script>

// http://stackoverflow.com/questions/149055/how-can-i-format-numbers-as-money-in-javascript
Number.prototype.formatMoney = function(c, d, t){
var n = this, 
    c = isNaN(c = Math.abs(c)) ? 2 : c, 
    d = d == undefined ? "," : d, 
    t = t == undefined ? "." : t, 
    s = n < 0 ? "-" : "", 
    i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "", 
    j = (j = i.length) > 3 ? j % 3 : 0;
   return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
};

// d3.json("projects.json", function(error, projects) {
// d3.json("projects_big.json", function(error, projects) {
// d3.json("projects_1000.json", function(error, projects) {
d3.json("projects_all.json", function(error, projects) {

  // Various formatters.
  var formatNumber = d3.format(",d"),
      formatChange = d3.format("+,d"),
      formatMonth = d3.time.format("%B %Y"),
      formatDate = d3.time.format("%B %d, %Y"),
      formatTime = d3.time.format("%I:%M %p");


  // A nest operator, for grouping the project list.
  var nestByDate = d3.nest()
      .key(function(d) {
        return d3.time.month(d.date); 
      });

  // A little coercion, since the JSON is untyped.
  projects.forEach(function(d, i) {
    d.index = i;
    d.date = new Date(d.start_date * 1000);
    d.end_date = new Date(d.end_date * 1000);


    if (d.participants[0] && d.participants[0].country) {
      d.leaderCountry = d.participants[0].country;

      if ('lat' in d.participants[0] && 'lon' in d.participants[0]) {
        d.lat = d.participants[0].lat;
        d.lon = d.participants[0].lon;
      }

    }  else {
      d.leaderCountry = 'unknown';
    }
  });

  // Create the crossfilter for the relevant dimensions and groups.
  var project = crossfilter(projects);
  var all = project.groupAll();
      
  var date = project.dimension(function(d) { return d.date; });
  var dates = date.group(d3.time.day);
      
  var end_date = project.dimension(function(d) { return d.end_date; });
  var end_dates = end_date.group(d3.time.day);

  var index = project.dimension(function(d) { return d.rcn; });

  var byFunding = project.dimension(function (d) { return d.funding; });

  var byCountry = project.dimension(function(d) { return d.leaderCountry; });

  // var byLocation = project.dimension(function(d) { 
  //   if ('lat' in d) {
  //     return [d.lat, d.lon];
  //   } else {
  //     return [0,0];
  //   }
  // });

  var byProjectCall = project.dimension(function (d) { return d.project_call; });

  var charts = [

    barChart()
        .dimension(date)
        .group(dates)
        .round(d3.time.day.round)
      .x(d3.time.scale()
        .domain([new Date(2006, 0, 1), new Date(2020, 3, 1)])
        .rangeRound([0, 10 * 90]))
        .filter([new Date(2006, 1, 1), new Date(2020, 2, 1)]),

    barChart()
        .dimension(end_date)
        .group(end_dates)
        .round(d3.time.day.round)
      .x(d3.time.scale()
        .domain([new Date(2006, 0, 1), new Date(2020, 3, 1)])
        .rangeRound([0, 10 * 90]))
        .filter([new Date(2006, 1, 1), new Date(2020, 2, 1)])
  ];

  // The map
  var map = new L.Map("map", {center: [48, 9], zoom: 3})
    .addLayer(new L.TileLayer("http://{s}.tile.cloudmade.com/{key}/997/256/{z}/{x}/{y}.png", {
      attribution: '<b>Developed by <a href="http://openconsortium.eu/" target="_blank" class="oc-logo">Open Consortium</a>.</b> Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
      // key: '03d33ad133d34ae39b3990819a502f17',
      key: 'c8744de7fa7944169afa48842c7fcbdb',
      // styleId: 22677
      // styleId: 997,
      maxZoom: 18,
    }));

  var markers = L.markerClusterGroup({showCoverageOnHover:false,maxClusterRadius:40});
  var markers_list = {};
  map.addLayer(markers);

  // Given our array of charts, which we assume are in the same order as the
  // .chart elements in the DOM, bind the charts to the DOM and render them.
  // We also listen to the chart's brush events to update the display.
  var chart = d3.selectAll(".chart")
      .data(charts)
      .each(function(chart) { chart.on("brush", renderAll).on("brushend", renderAll); });

  // Render the initial lists.
  var list = d3.selectAll("#project-list")
      .data([projectList]);

  // Render the initial country list
  var listCountries = d3.select("#country-list")
      .data([countryList]);

  var listProjectCalls = d3.select('#project-calls-list')
    .data([projectCallList]);

  // Render the total.
  d3.selectAll("#total")
      .text(formatNumber(project.size()));

  renderAll();

  // Renders the specified chart or list.
  function render(method) {
    d3.select(this).call(method);
  }

  // Whenever the brush moves, re-rendering everything.
  function renderAll() {
    chart.each(render);
    list.each(render);
    listCountries.each(render);
    listProjectCalls.each(render);
    d3.select("#active").text(formatNumber(all.value()));
    mapData();
  }

  function dateMonthDifference(d1, d2) {
    return d2.getMonth() - d1.getMonth() + 
            (12 * (d2.getFullYear() - d1.getFullYear()));
  }

  window.filter = function(filters) {
    filters.forEach(function(d, i) { charts[i].filter(d); });
    renderAll();
  };

  // This gets triggered by the country click and reduces data
  window.filterCountry = function(country) {
    byCountry.filter(country);
    renderAll();
  };

  window.filterProjectCall = function(call) {
    byProjectCall.filter(call);
    renderAll();
  }

  window.reset = function(i) {
    charts[i].filter(null);
    renderAll();
  };

  window.showModal = function(rcn) {
    index.filter(rcn);
    index.top(Infinity).forEach(function(p,i) {
      console.log(p); 
      d3.select('#datapointevent').text(p.title);
    });
    index.filterAll(null);
    $('#myModal').modal('toggle');
    window.history.replaceState("", "title", "?rcn="+rcn);

  };

  function mapData() {
    markers.clearLayers();

    byFunding.top(50).forEach(function(d, i) {
      leader = d.participants[0];
      if (leader && 'lat' in leader && 'lon' in leader) {
        var marker = L.marker([leader.lat, leader.lon]);
        markers.addLayer(marker);
      }
    });

    map.fitBounds(markers);
  }

  // // Filter data on cluster click
  // markers.on('clusterclick', function (a) {
  //   // console.log(a);

  //   selected = a.layer.getAllChildMarkers();
  //   // console.log(selected);
  //   // 
    

  //     selected.forEach(function (k) {
  //       console.log(k);
  //     });




  //   byLocation.filterFunction(function (d) {
  //     // console.log(d);
  //     // for
  //     // 
      

  //     // for (var k in selsected) {
  //       // if (d.lat = )
  //     // }
  //   });
  // });

  function countryList(div) {
    div.each(function() {
      var countries = d3.select(this).selectAll(".country")
        .data(byCountry.group().top(Infinity), function(d) {
          return d.key+d.value;
      });

      var countriesEnter = countries.enter()
        .append("div")
        .attr("class", "country")
        .append("a")
        .attr("class", "title")
        .attr('href', '#')
        .attr('onclick', function(d) { 
          return ("javascript:filterCountry('"+d.key+"');return false;"); 
        })
        .text(function(d) { return d.key+" ("+d.value+")"; });

      countries.exit().remove();
      countries.order();

    });
  }

  function projectCallList(div) {
    div.each(function() {
      var projectCalls = d3.select(this).selectAll(".project-call")
        .data(byProjectCall.group().top(Infinity), function(d) {
          return d.key+d.value;
      });

      var enter = projectCalls.enter()
        .append("div")
        .attr("class", "project-call")
        .append("a")
        .attr("class", "title")
        .attr('href', '#')
        .attr('onclick', function(d) { 
          return ("javascript:filterProjectCall('"+d.key+"');return false;"); 
        })
        .text(function(d) { return d.key+" ("+d.value+")"; });

      projectCalls.exit().remove();
      projectCalls.order();

    });    
  }

  function projectList(div) {
    var projectsByDate = nestByDate.entries(date.top(50));

    div.each(function() {
      var date = d3.select(this).selectAll(".date")
          .data(projectsByDate, function(d) { return d.key; });

      date.enter()
        .append("div")
        .attr("class", "date")
        .append("div")
        .attr("class", "day")
        .text(function(d) { return formatMonth(d.values[0].date); });

      date.exit().remove();

      var project = date.order().selectAll(".flight")
          .data(function(d) { return d.values; }, function(d) { return d.index; });

      var projectEnter = project.enter().append("div")
          .attr("class", "flight");

      projectEnter.append("div")
          .attr("class", "acronym")
          .append("a")
          // .attr("href", function(d) { return ("?rcn=" + d.rcn); })
          .attr("onclick",function(d) { return ("javascript:showModal('"+d.rcn+"'); return false;"); })
          .text(function(d) { return d.project_acronym; });

      projectEnter.append("div")
          .attr("class", "project-call")
          .text(function(d) { return d.project_call; });

      projectEnter.append("div")
          .attr("class", "funding")
          .text(function(d) {
            // var formatCurrency = d3.format("$,.0f");
            // return formatCurrency(d.funding);
            return (parseInt(d.funding)).formatMoney(0); 
          });

      projectEnter.append("div")
          .attr('class', 'duration')
          .text(function(d) { return dateMonthDifference(d.date, d.end_date); });

      project.exit().remove();

      project.order();
    });
  }

  function barChart() {
    if (!barChart.id) barChart.id = 0;

    var margin = {top: 10, right: 10, bottom: 20, left: 10},
        x,
        y = d3.scale.linear().range([100, 0]),
        id = barChart.id++,
        axis = d3.svg.axis().orient("bottom"),
        brush = d3.svg.brush(),
        brushDirty,
        dimension,
        group,
        round;

    function chart(div) {
      var width = x.range()[1],
          height = y.range()[0];

      y.domain([0, group.top(1)[0].value]);

      div.each(function() {
        var div = d3.select(this),
            g = div.select("g");

        // Create the skeletal chart.
        if (g.empty()) {
          div.select(".title").append("a")
              .attr("href", "javascript:reset(" + id + ")")
              .attr("class", "reset")
              .text("reset")
              .style("display", "none");

          g = div.append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          g.append("clipPath")
              .attr("id", "clip-" + id)
            .append("rect")
              .attr("width", width)
              .attr("height", height);

          g.selectAll(".bar")
              .data(["background", "foreground"])
            .enter().append("path")
              .attr("class", function(d) { return d + " bar"; })
              .datum(group.all());

          g.selectAll(".foreground.bar")
              .attr("clip-path", "url(#clip-" + id + ")");

          g.append("g")
              .attr("class", "axis")
              .attr("transform", "translate(0," + height + ")")
              .call(axis);

          // Initialize the brush component with pretty resize handles.
          var gBrush = g.append("g").attr("class", "brush").call(brush);
          gBrush.selectAll("rect").attr("height", height);
          gBrush.selectAll(".resize").append("path").attr("d", resizePath);
        }

        // Only redraw the brush if set externally.
        if (brushDirty) {
          brushDirty = false;
          g.selectAll(".brush").call(brush);
          div.select(".title a").style("display", brush.empty() ? "none" : null);
          if (brush.empty()) {
            g.selectAll("#clip-" + id + " rect")
                .attr("x", 0)
                .attr("width", width);
          } else {
            var extent = brush.extent();
            g.selectAll("#clip-" + id + " rect")
                .attr("x", x(extent[0]))
                .attr("width", x(extent[1]) - x(extent[0]));
          }
        }

        g.selectAll(".bar").attr("d", barPath);
      });

      function barPath(groups) {
        var path = [],
            i = -1,
            n = groups.length,
            d;
        while (++i < n) {
          d = groups[i];
          path.push("M", x(d.key), ",", height, "V", y(d.value), "h9V", height);
        }
        return path.join("");
      }

      function resizePath(d) {
        var e = +(d == "e"),
            x = e ? 1 : -1,
            y = height / 3;
        return "M" + (.5 * x) + "," + y
            + "A6,6 0 0 " + e + " " + (6.5 * x) + "," + (y + 6)
            + "V" + (2 * y - 6)
            + "A6,6 0 0 " + e + " " + (.5 * x) + "," + (2 * y)
            + "Z"
            + "M" + (2.5 * x) + "," + (y + 8)
            + "V" + (2 * y - 8)
            + "M" + (4.5 * x) + "," + (y + 8)
            + "V" + (2 * y - 8);
      }
    }

    brush.on("brushstart.chart", function() {
      var div = d3.select(this.parentNode.parentNode.parentNode);
      div.select(".title a").style("display", null);
    });

    brush.on("brush.chart", function() {
      var g = d3.select(this.parentNode),
          extent = brush.extent();
      if (round) g.select(".brush")
          .call(brush.extent(extent = extent.map(round)))
        .selectAll(".resize")
          .style("display", null);
      g.select("#clip-" + id + " rect")
          .attr("x", x(extent[0]))
          .attr("width", x(extent[1]) - x(extent[0]));
      dimension.filterRange(extent);
    });

    brush.on("brushend.chart", function() {
      if (brush.empty()) {
        var div = d3.select(this.parentNode.parentNode.parentNode);
        div.select(".title a").style("display", "none");
        div.select("#clip-" + id + " rect").attr("x", null).attr("width", "100%");
        dimension.filterAll();
      }
    });

    chart.margin = function(_) {
      if (!arguments.length) return margin;
      margin = _;
      return chart;
    };

    chart.x = function(_) {
      if (!arguments.length) return x;
      x = _;
      axis.scale(x);
      brush.x(x);
      return chart;
    };

    chart.y = function(_) {
      if (!arguments.length) return y;
      y = _;
      return chart;
    };

    chart.dimension = function(_) {
      if (!arguments.length) return dimension;
      dimension = _;
      return chart;
    };

    chart.filter = function(_) {
      if (_) {
        brush.extent(_);
        dimension.filterRange(_);
      } else {
        brush.clear();
        dimension.filterAll();
      }
      brushDirty = true;
      return chart;
    };

    chart.group = function(_) {
      if (!arguments.length) return group;
      group = _;
      return chart;
    };

    chart.round = function(_) {
      if (!arguments.length) return round;
      round = _;
      return chart;
    };

    return d3.rebind(chart, brush, "on");
  }
});



</script>
<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
<script src="lib/Leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="lib/bootstrap/js/bootstrap.min.js"></script>
